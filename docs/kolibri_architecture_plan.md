# Архитектура Kolibri-x vX и план поставки

## 1. Видение и руководящие принципы
- **Измеримый интеллект:** каждая возможность должна повышать мультимодальную метрику KSI (mKSI) Kolibri по обобщающей способности, экономности, автономности, надёжности, объяснимости и удобству.
- **Доверие и контроль человека:** приватность, происхождение данных и объяснимость — первоклассные требования, а не довесок.
- **Комбинируемое мышление:** мультимодальные навыки, знания и инструменты взаимодействуют через явные контракты и общий рантайм.
- **Устойчивость с приоритетом офлайн:** критичные потоки работают локально и синхронизируются оппортунистически, сохраняя контроль у пользователя.

## 2. Слоистая системная архитектура

```
┌────────────────────────────────────────────────────────────────┐
│                        Пользовательские поверхности            │
│  (приложения/веб/AR/CLI) → Планировщик задач → SkillStore →    │
│                          песочницы инструментов                │
└────────────────────────────────────────────────────────────────┘
           │ события/запросы                    │ ответы/логи
┌────────────────────────────────────────────────────────────────┐
│                 Слой оркестрации рантайма                      │
│  Менеджер сессий · Движок воркфлоу · Офлайн-кэш · Шина синхр.  │
└────────────────────────────────────────────────────────────────┘
           │ мультимодальные токены/логи       │ планы/контекст
┌────────────────────────────────────────────────────────────────┐
│                 Ядро мультимодального мышления                 │
│  Энкодеры · Фьюжн-трансформер · Нейро-семантический планировщик│
└────────────────────────────────────────────────────────────────┘
           │ рёбра сущность/событие            │ доказательства/запросы
┌────────────────────────────────────────────────────────────────┐
│             Нейро-семантическая память и поиск                 │
│  Локальный граф знаний · RAG-пайплайны · Проверка фактов       │
└────────────────────────────────────────────────────────────────┘
           │ сигналы персонализации            │ политики/ключи
┌────────────────────────────────────────────────────────────────┐
│        Приватность, персонализация и управление                │
│  Профайлер · Оператор приватности · Фед. обучение · Аудит-лог  │
└────────────────────────────────────────────────────────────────┘
           │ телеметрия (опционально)            │ метрики/отчёт
┌────────────────────────────────────────────────────────────────┐
│        Наблюдаемость, XAI и безопасность                       │
│  XAI-панели · Контент-фильтры · Этические гарды · mKSI-оценка  │
└────────────────────────────────────────────────────────────────┘
```

### 2.1. Ядро мультимодального мышления
- **Энкодеры:** модульные энкодеры текста, речи (ASR), аудио, изображения/видео (кадры) и сенсорных потоков с общим эмбеддинг-пространством.
- **Фьюжн-трансформер:** модель перекрёстного внимания, объединяющая токенизированные события/кадры в единый контекст для рассуждений и планирования инструментов.
- **Нейро-семантический планировщик:** переводит намерения в упорядоченные вызовы навыков с критериями успеха и требуемыми доказательствами.
- **Стриминговый интерфейс:** поддерживает инкрементальное поглощение (например, живую транскрибацию) и частичные обновления планов.

### 2.2. Нейро-семантическая память и извлечение
- **Граф знаний (KG):** локальный property-граф, в котором хранятся сущности, события, утверждения, источники и задачи. Хранилище на JSONL с индексами по идентификаторам узлов и временным фасетам.
- **RAG-контур:** планировщик формирует семантические запросы → извлечение из KG → подбор документов/фактов → компоновка промпта для ядра → проверенный ответ.
- **Пайплайн достоверности:** ранжирование источников (доверие, актуальность), детекция противоречий, внедрение ссылок в выводы планировщика и отказ от ответа при уверенности ниже порога.

### 2.3. Приватность, персонализация и управление
- **Профайлер на устройстве:** изучает предпочтения пользователя (стиль, тон, паттерны задач) через федеративное обучение с безопасной агрегацией и дифференциальной приватностью.
- **Эмпатический слой:** создаёт вектора модуляции (тон, темп, формальность), применяемые при декодировании ответа.
- **Оператор приватности:** применяет политики согласий к типам данных, управляет офлайн-режимом, ключами шифрования и пользовательскими переключателями.
- **Журнал действий:** хеш-цепочка Меркла, фиксирующая мультимодальные входы, планы, вызовы навыков и ссылки на доказательства для аудита.

### 2.4. Экосистема навыков и инструментов
- **SkillStore:** декларативные манифесты (`skill.json`), разрешения на основе возможностей, изолированное исполнение (контейнер или WASI), биллинг-хуки и процесс ревью.
- **Планировщик задач/воркфлоу:** поддержка долгих проектов, дедлайнов, напоминаний и отслеживания зависимостей с механизмами отката.
- **Специализированные наборы навыков:** доменные модули (код-ревью, UI-дизайн, оркестрация IoT, юр-анализ, STEM-симуляции), распространяемые через SkillStore.

### 2.5. Наблюдаемость, объяснимость и безопасность
- **XAI-консоль:** визуальная цепочка рассуждений, оценки уверенности, ссылки на источники, альтернативные гипотезы и сравнение версий плана.
- **Контент- и этические фильтры:** настраиваемый движок политик, включая стоп-классы NSFW/биометрии и «детский режим».
- **Оценочный стенд:** дашборды mKSI, миссии (STEM, код, юридические обзоры, аудио-встречи, визуальные задачи), регрессионные наборы и синтетическая лаборатория.

### 2.6. Оркестрация рантайма и пользовательские поверхности
- **Рантайм-ядро:** координирует контекст сессий, управляет асинхронными вызовами навыков и сохраняет состояние в офлайн-кэше.
- **Движок синхронизации:** оппортунистическая синхронизация с разрешением конфликтов и версионированием для KG и журналов.
- **Клиентские поверхности:** веб-дэшборд, AR-оверлей, CLI и API-шлюз используют общие контракты оркестрации.

## 3. Обзор потоков данных
1. **Взаимодействие с пользователем:** слой опыта захватывает мультимодальные входы (текст, голос, изображение) и метаданные, сразу применяя политики приватности.
2. **Кодирование:** входы проходят через модальные энкодеры, создающие согласованные токены для фьюжн-трансформера.
3. **Планирование:** ядро находит намерения, обращается к KG через RAG, а нейро-семантический планировщик строит граф навыков и задач.
4. **Исполнение:** рантайм отправляет навыки в песочницы SkillStore. Инструменты выдают результаты и доказательства, которые добавляются в журнал действий.
5. **Верификация:** выходы проверяются по KG и пайплайну достоверности. Несогласованности запускают циклы уточнения или отказ.
6. **Персонализация:** эмпатический слой корректирует ответы; профайлер обновляет модели через федеративные градиенты при наличии подключения.
7. **Объяснимость и логирование:** цепочка рассуждений, уверенность и цитаты отправляются в XAI-панель; подписанные записи журнала хранятся локально и при необходимости синхронизируются.

## 4. Дорожная карта поставки (MVP на 12 недель)

### Этап A — Фундамент (недели 1–4)
- **Мультимодальная база:** выпустить текстовый и ASR-энкодеры плюс энкодер изображений/видео по ключевым кадрам. Интегрировать с прототипом фьюжн-трансформера.
- **KG v1:** локальный JSONL property-граф с индексами, CRUD-API и временными/версионными фасетами.
- **RAG с проверкой:** реализовать пайплайн извлечения, ранжирование источников и проверки согласованности с режимом «нет ответа» при низкой уверенности.
- **SkillStore v1:** валидация манифестов, песочница, токены доступа и базовая инструментализация биллинга.
- **Прозрачность рассуждений:** структурированный лог цепочки мышления со ссылками на источники и простая веб-визуализация.
- **Основы приватности:** управление согласиями, офлайн-кэш и базовое шифрование сохранённых логов.

### Этап B — Интеллект и персонализация (недели 5–8)
- **Профайлер + федеративное обучение:** пайплайн агрегации градиентов с безопасным сервером и добавлением DP-шума.
- **Эмпатическая модуляция:** векторы стиля/темпа, влияющие на декодирование ответов; настройки по пользователям.
- **Контур активного обучения:** модель просит пользователя предоставить уточняющие данные/ярлыки; очередь задач для аннотаций.
- **Планировщик задач/воркфлоу:** поддержка многошаговых проектов, дедлайнов, напоминаний и сохранения состояния.

### Этап C — Качество и UX (недели 9–12)
- **XAI-панель:** интерактивная визуализация с регуляторами уверенности, сравнением доказательств и альтернативных планов.
- **Миссии для оценки:** пакеты миссий для STEM, кодинга, юридических обзоров, аудио-встреч и работы с изображениями. Автоматические отчёты mKSI.
- **IoT-мост (альфа):** защищённый канал команд с политиками возможностей, интеграцией с журналом действий и механизмом отката.

## 5. API-контракты (объём MVP)
- **Манифест навыка (`skill.json`):** описывает входы, разрешения, биллинг и точки входа.
- **Единица факта в графе знаний:** фиксирует текст утверждения, источники, связи поддержки/противоречия, уверенность и временные метки.
- **Схема планировщика задач:** определяет цели, последовательность инструментов, дедлайны и расписание напоминаний.
- **Формат записи журнала:** канонический JSON с детерминированной подписью (`hash`, `hmac`), совместимый с существующей цепочкой логов Kolibri.

## 6. Защита и приватность
- **Песочницы:** каждый навык выполняется в контейнере/WASI с ограничениями по сети и файловой системе.
- **Политики данных:** явные согласия по каждой модальности и классу хранения; офлайн-режим блокирует внешние передачи.
- **Безопасность фед. обучения:** безопасная агрегация, бюджеты дифф-приватности и аттестация клиентов.
- **Журнал с подписью Меркла:** расширяет цепочку Kolibri v4 на мультимодальные события и позволяет внешнюю верификацию.
- **Мультимодальные гарды:** детекторы NSFW/биометрии, пакет «child-safe» и немедленные стоп-экшены.

## 7. Метрики и оценка (mKSI)
- **Обобщение (G):** точность на задачах разных доменов и модальностей.
- **Экономность (P):** отношение минимального использования навыков/инструментов к качеству результата.
- **Автономность (A):** улучшение, достигнутое благодаря вмешательствам активного обучения.
- **Надёжность (R):** доля успешных повторных запусков, включая офлайн-режим.
- **Объяснимость (E):** полнота и точность ссылок и визуализаций рассуждений.
- **Удобство (U):** время выполнения задач, количество ошибок UX и удовлетворённость пользователей.
- **Цель:** mKSI ≥ 0,75 на миссиях по коду, документам, аудио-встречам и изображениям.

## 8. Структура репозитория (каркас)
```
kolibri-x/
  core/         # Фьюжн-трансформер, планировщики, энкодеры
  kg/           # Хранилище графа знаний, извлечение, верификация
  skills/       # SDK навыков, манифесты, инструменты песочницы
  privacy/      # Оператор приватности, менеджер согласий, профайлер
  xai/          # Визуализация рассуждений, API объяснимости
  runtime/      # Оркестрационное ядро, офлайн-кэш, движок синхронизации
  apps/         # Пользовательские поверхности (web, AR, CLI)
  eval/         # Миссии, mKSI-оценщики, синтетическая лаборатория
```

## 9. Управление рисками и операционные плейбуки
- **Контроль галлюцинаций:** обязательная верификация доказательств, политика «лучше без ответа», запросы уточнений при низкой уверенности.
- **Гарантии приватности:** локальная обработка по умолчанию, минимальный перенос данных и прозрачные журналы согласий.
- **Управление сложностью:** модульные интерфейсы, версионируемые контракты и непрерывные миссии интеграции по слоям.
- **Настройка производительности:** инкрементальные обновления KG, потоковый ASR, квантизация моделей и ускорение на периферии.

## 10. Следующие шаги
1. Создать архитектурную гильдию с лидами по слоям (ядро, KG, навыки, приватность, XAI, рантайм).
2. Определить бэклог эпиков этапа A с критериями приёмки и прогнозом влияния на mKSI.
3. Развернуть оценочный стенд с базовыми метриками для еженедельного мониторинга улучшений.
4. Согласовать проверку безопасности песочниц, подписи журналов и фед-обучения до пользовательских испытаний.

## 11. Прогресс реализации

### Спринт A — фундамент реализован
- **Каркас мультимодального ядра:** добавлены детерминированные энкодеры текста, аудио и изображений плюс заготовка фьюжн-трансформера, чтобы разблокировать последующие пайплайны.
- **Нейро-семантический планировщик:** реализован облегчённый планировщик, который сопоставляет цели пользователя с доступными манифестами SkillStore и строит планы с учётом зависимостей.
- **Граф знаний + RAG-контур:** поставлен локальный KG на JSONL с детекцией конфликтов и извлечением, подкладывающим подтверждённые источниками доказательства.
- **Приватность и гарды рантайма:** начальный оператор приватности применяет политики согласий, а офлайн-кэш гарантирует детерминированное вытеснение для локального режима.
- **Контракты SkillStore:** загрузчик манифестов и проверки разрешений позволяют ранним партнёрским навыкам интегрироваться с оркестратором.
- **Прозрачность рассуждений:** логи рассуждений фиксируют шаги извлечения и проверки для будущей XAI-консоли.
