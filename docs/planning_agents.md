# Планирование и агенты Kolibri: архитектура и дорожная карта

## Обзор

Этот документ описывает целевую архитектуру и ключевые компоненты подсистемы "Планирование и агенты" (пункты 9–16 генеральной программы модернизации Kolibri). Подсистема должна обеспечить многоуровневое планирование, гибкое распределение задач между агентами, поддержку пользовательских предпочтений и устойчивое накопление опыта.

## 9. Иерархический планировщик задач с самооценкой рисков

### Цели
- Формирование планов на стратегическом, тактическом и операционном уровнях.
- Автоматический выбор подагентов для исполнения подзадач.
- Оценка рисков и вероятности срыва на каждом уровне.

### Архитектура
1. **Strategic Planner (SP)**: принимает цели высокого уровня, декомпозирует на эпики/миссии.
2. **Tactical Planner (TP)**: строит дорожные карты спринтов и назначает подагентов.
3. **Operational Planner (OP)**: формирует очереди конкретных действий и мониторит выполнение.
4. **Risk Assessor (RA)**: вычисляет риск-компоненты (вероятность/влияние) на базе истории, сложностей и загрузки агентов.
5. **Agent Selector (AS)**: выбирает подагентов с учётом навыков и текущего риска.

### Поток данных
1. Пользовательская цель → SP → декомпозиция → риск-анализ SP.
2. SP выдаёт миссии → TP → планирование спринтов → риск-анализ TP.
3. TP порождает задачи → OP → расписания → риск-анализ OP.
4. AS назначает агентов, RA обновляет риски по мере выполнения.

### Метрики
- Expected Plan Risk (EPR): агрегированная метрика риска по дереву плана.
- Agent Fit Score (AFS): соответствие навыков подагента задачам.
- Plan Confidence Index (PCI): итоговая уверенность в выполнении.

## 10. Нейро-семантическая декомпозиция целей

### Компоненты
1. **Neuro-Semantic Encoder (NSE)**: мультимодальный энкодер целей.
2. **Preference Profiler (PP)**: хранит предпочтения пользователя (тон, сроки, ограничения).
3. **Resource Constraint Model (RCM)**: прогнозирует доступность ресурсов (время, вычисления, бюджет).
4. **Goal Decomposer (GD)**: трансформер с вниманием к предпочтениям/ограничениям, выдаёт дерево задач.

### Процесс
- Вход: цель + контекст пользователя.
- NSE генерирует эмбеддинг.
- PP/RCM накладывают веса и маски.
- GD строит дерево задач с метками приоритетов, ограничений и рисков.

### Выход
- Семантическое дерево задач.
- Набор ограничений и SLA.
- Параметры для Risk Assessor.

## 11. Стохастический симулятор альтернативных планов

### Модуль **Plan Monte-Carlo Simulator (PMCS)**
- Сэмплирование альтернативных планов с помощью вероятностных моделей переходов между состояниями.
- Учитывает вариативность ресурсов, задержек, вероятные сбои.
- Для каждого плана вычисляется Cost of Execution (CoE) и Probability of Success (PoS).

### Подход
1. Построение модели марковского процесса для задач.
2. Монте-карло симуляции (N итераций).
3. Агрегация результатов: средняя стоимость, доверительные интервалы, сценарии риска.
4. Выбор стратегии с минимальной ожидаемой стоимостью при PoS ≥ порога.

## 12. Координационный слой между агентами

### Компоненты
- **Agent Registry (AR)**: метаданные агентов (навыки, рейтинг, история).
- **Load Balancer (LB)**: мониторинг загрузки, очередей и SLO.
- **Skill Matcher (SM)**: сопоставление задач навыкам.
- **Coordination Bus (CB)**: событийная шина для коммуникации агентов.

### Функции
- Реалтайм распределение задач с учётом загрузки.
- Поддержка переговоров между агентами (обмен контекстом, делегирование).
- Интеграция с Risk Assessor для переназначения при росте риска.

## 13. Интерактивный план-граф с голосовыми правками

### Интерфейс
- **PlanGraph UI**: веб-приложение с визуализацией DAG планов.
- **Voice Command Processor (VCP)**: распознавание речи, намерений и правок.
- **Change Propagation Engine (CPE)**: вносит изменения в план и синхронизирует с планировщиками.

### Возможности
- Просмотр дерева задач, статусов, рисков.
- Добавление/удаление задач, изменение приоритетов голосом.
- Отображение результатов симуляций и альтернативных стратегий.

## 14. Самоисправляющиеся цепочки

### Модуль **Self-Healing Chain Manager (SHCM)**
- Мониторит KPI шагов (время, точность, удовлетворенность).
- Сравнивает с библиотекой оптимизированных шаблонов.
- При детекции неэффективного шага запускает Auto-Replace:
  - Захватывает контекст.
  - Подбирает шаблон.
  - Пересчитывает плановые риски и стоимость.
- Логирует изменения для аудита.

## 15. Долгосрочная память планов

### Компоненты
- **Plan Memory Store (PMS)**: версионированное хранилище (например, CRDT + объектное хранилище).
- **Replay Engine (RE)**: воспроизведение успешных сценариев.
- **Memory Indexer (MI)**: семантический поиск по прошлым планам.
- **Retention Policy Manager (RPM)**: управление жизненным циклом.

### Возможности
- Версии планов с метаданными (цель, участники, метрики успеха).
- Аналитика успешных паттернов.
- Быстрый старт новых миссий на основе шаблонов.

## 16. Библиотека типовых миссий

### Структура
- **Mission Templates (MT)**: JSON/YAML описания миссий.
- **Parameter Schema (PS)**: определение параметров (ресурсы, сроки, роли).
- **Success Metrics (SMx)**: набор KPI, которые мониторятся планировщиком.
- **Compliance Rules (CR)**: обязательные проверки (безопасность, политика).

### Поток работы
1. Аналитики формируют миссию → описание в MT.
2. Планировщик использует PS для адаптации под конкретного пользователя.
3. SMx интегрируются в RA/PMCS для оценки результатов.
4. Успешные миссии архивируются в PMS.

## Дорожная карта реализации

| Этап | Основные результаты | Зависимости |
|------|--------------------|-------------|
| **M1** | Базовая иерархия планировщиков, Risk Assessor, Agent Selector | Создание Agent Registry |
| **M2** | Нейро-семантическая декомпозиция, Preferences & Constraints | M1 |
| **M3** | Стохастический симулятор, интеграция с планировщиками | M2 |
| **M4** | Координационный слой, Load Balancer, Skill Matcher | M1 |
| **M5** | План-граф UI + голосовые правки | M2 |
| **M6** | Self-Healing Chain Manager, шаблонная библиотека | M3, M4 |
| **M7** | Долгосрочная память, Replay Engine, метрики успеха | M6 |

## Технические заметки
- Использовать микросервисную архитектуру с общим событийным шиной (Kafka/NATS).
- Хранение миссий и планов — в базе с поддержкой графовых запросов (Neo4j/ArangoDB) плюс объектное хранилище.
- ML-модули (NSE, GD, RA) разворачивать как сервисы с gRPC API.
- План-граф UI строить на WebGL/TypeScript с сервером сигнализации для обновлений в реальном времени.
- Голосовые правки реализовать через ASR (например, Whisper) и NLU слой с intent-слотами.
- Безопасность: RBAC на уровне агентов, аудит изменений планов.

