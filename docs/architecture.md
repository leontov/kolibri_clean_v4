# Архитектура Kolibri-x

> Актуальность проверяет Кочуров Владислав Евгеньевич. Перед слиянием кода
> с изменениями архитектуры обновляйте этот файл и указывайте ссылку в PR.

## Слоистая модель

```
┌───────────────────────────────────────────────────────────────────────┐
│ Пользовательские поверхности (веб/CLI/AR)                             │
│  ↓ планировщик задач → SkillStore → песочницы                         │
└───────────────────────────────────────────────────────────────────────┘
           │ события/запросы                     │ ответы/логи
┌───────────────────────────────────────────────────────────────────────┐
│ Оркестрация рантайма                                                  │
│  менеджер сессий · движок воркфлоу · офлайн-кэш · шина синхронизации  │
└───────────────────────────────────────────────────────────────────────┘
           │ мультимодальные токены             │ планы/контекст
┌───────────────────────────────────────────────────────────────────────┐
│ Ядро мультимодального мышления                                        │
│  энкодеры · фьюжн-трансформер · нейро-семантический планировщик        │
└───────────────────────────────────────────────────────────────────────┘
           │ рёбра сущность/событие            │ доказательства/запросы
┌───────────────────────────────────────────────────────────────────────┐
│ Нейро-семантическая память и поиск                                    │
│  локальный граф знаний · RAG · проверка фактов                        │
└───────────────────────────────────────────────────────────────────────┘
           │ сигналы персонализации          │ политики/ключи
┌───────────────────────────────────────────────────────────────────────┐
│ Приватность и персонализация                                         │
│  профайлер · оператор приватности · федеративное обучение             │
└───────────────────────────────────────────────────────────────────────┘
           │ телеметрия (опционально)        │ метрики/отчётность
┌───────────────────────────────────────────────────────────────────────┐
│ Наблюдаемость, XAI и безопасность                                     │
│  reasoning log · контент-фильтры · mKSI                               │
└───────────────────────────────────────────────────────────────────────┘
```

### Ядро мультимодального мышления
- **Энкодеры** (`kolibri_x/core/encoders.py`): текстовый BOW, детерминированный
  ASR-плейсхолдер, хэш-энкодер изображений, адаптивные версии для аудио и
  видео, контроллер разрешений и временной выравниватель. Расширяются
  специализациями из [multimodal_core](multimodal_core.md):
  `OnlineTokenizer` для видео, `NoiseProfiler`/`SpeakerAdaptor` для аудио,
  сенсорные токены IoT.
- **FusionTransformer** (`kolibri_x/core/transformer.py`): связывает сигналы
  модальностей в единое представление, поддерживает
  `DynamicDepthController` и адаптивное перекрёстное внимание для экономии
  вычислений на Edge.
- **NeuroSemanticPlanner** (`kolibri_x/core/planner.py`): строит многошаговые
  планы с зависимостями на основе зарегистрированных навыков, учитывает
  последовательности из `hints` и поддерживает приоритет по контексту;
  получает от трансформера метаданные о выбранной глубине и полезности
  модальностей для корректировки шагов.
- **Fractal Self-Learning Loop** (`core/engine.c`, `core/digit.c`): цифры
  пересматривают собственный опыт, переоценивают формулы на актуальном
  датасете и генерируют вариации лучших решений. Такое локальное
  самообучение позволяет обновлять память без внешнего корпуса и
  автоматически усиливать успешные стратегии на каждом тике.

### Память и поиск
- **KnowledgeGraph** (`kolibri_x/kg/graph.py`): property-граф на JSONL с
  индексами, дедупликацией и отслеживанием конфликтов.
- **RAGPipeline** (`kolibri_x/kg/rag.py`): формирует запросы по узлам/ребрам,
  ранжирует результаты, включает проверку противоречий и решение «нет
  ответа».
- **KnowledgeIngestor** (`kolibri_x/kg/ingest.py`): принимает документы,
  нормализует факты, связывает с источниками и обновляет KG.

### Оркестрация рантайма
- **KolibriRuntime** (`kolibri_x/runtime/orchestrator.py`): объединяет энкодеры,
  планировщик, RAG, SkillStore, приватность и журнал; сохраняет успешные планы
  в кэш с историей использования и предоставляет API для их реплея без
  повторного планирования.
- **WorkflowManager** (`kolibri_x/runtime/workflow.py`): управляет
  долгоживущими задачами, напоминаниями и календарём.
- **OfflineCache** (`kolibri_x/runtime/cache.py`): хранит результаты и планы для
  офлайн-режима, реализует стратегию вытеснения и репликацию при
  синхронизации.
- **IoTBridge** (`kolibri_x/runtime/iot.py`): безопасная интеграция с
  устройствами, проверка разрешений и журнала команд.
- **ActionJournal** (`kolibri_x/runtime/journal.py`): совместим с цепочкой
  Kolibri v4, фиксирует шаги, подписи и ссылки на артефакты.

### Приватность, персонализация и навыки
- **PrivacyOperator** (`kolibri_x/privacy/consent.py`): политики согласий,
  аттестация клиентов, enforcement для модальностей.
- **OnDeviceProfiler** (`kolibri_x/personalization.py`): наблюдает за стилем и
  предпочтениями пользователя, агрегирует сигналы локально.
- **EmpathyModulator**: корректирует тон и скорость ответов, использует
  `EmpathyContext`.
- **SkillStore** (`kolibri_x/skills/store.py`): реестр навыков с проверкой
  политик и песочницей `SkillSandbox`.

### Наблюдаемость и безопасность
- **ReasoningLog** (`kolibri_x/xai/reasoning.py`): хранит цепочку рассуждений,
  уверенности и ссылки на источники.
- **Контент-фильтры** (`kolibri_x/privacy/filters.py`, `kolibri_x/xai/guards.py`)
  — применяются перед выдачей результатов.
- **mKSI-оценка** (`kolibri_x/eval/*`): набор миссий, метрик и отчётов.

## Языковой слой и интеграции

Kolibri удерживает языковые особенности «снаружи» ядра. Базовые сущности и
решатели оперируют цифровыми идентификаторами смыслов (`CONCEPT_ID`) и
формулами, поэтому все текстовые и голосовые поверхности подключаются через
ресурсы, уже присутствующие на устройствах:

- **Системные словари и раскладки** — API Android (`TextServicesManager`),
  iOS/macOS Input Sources, Windows IME или словари Linux-окружений служат
  источником разметки `surface → CONCEPT_ID`. Kolibri использует только мост,
  не копируя словари внутрь ядра.
- **Браузерные возможности** — `Intl.Collator`, `Intl.Segmenter` и Web Speech
  API позволяют сегментировать текст, нормализовать Unicode и выполнять
  распознавание речи без встроенных в Kolibri таблиц.
- **Фолбэк через Unicode** — стандартизированные таблицы нормализации и
  коллации присутствуют в ОС и рантаймах, поэтому ядро получает уже
  унифицированные токены.

Такой подход даёт «из коробки» многоязычность и избавляет ядро от тяжёлых
словарей. Kolibri остаётся цифровым мозгом, который работает исключительно с
числами, а конкретный язык пользователя обеспечивается поверхностным слоем
устройства.

## Потоки данных

1. **Сбор входов** — пользовательские поверхности отправляют текст, аудио,
   изображения и сигналы; приватность фильтрует их.
2. **Кодирование** — модальные энкодеры создают эмбеддинги и подают их в
   FusionTransformer.
3. **Планирование** — planner формирует план действий, учитывая KG и
   политики приватности.
4. **Исполнение** — runtime вызывает навыки через SkillStore/Sandbox,
   фиксируя результаты в журнале.
5. **Проверка** — RAG сверяет факты, контент-фильтры и операторы приватности
   подтверждают корректность.
6. **Персонализация** — модулятор эмпатии адаптирует ответ, профайлер обновляет
   модель (в офлайн-режиме очередь синхронизируется позже).
7. **Наблюдаемость** — ReasoningLog и ActionJournal сохраняют трассировку;
   `kolibri_verify` обеспечивает криптографическую проверку.

## Конфигурация

Файл `configs/kolibri.json` управляет поиском формул в бэкенде:

| Поле | Назначение | Диапазон |
| --- | --- | --- |
| `steps` | Количество итераций генерации/подбора формул. | 1–1000 |
| `depth_max` | Максимальная глубина выражений DSL. | 1–8 |
| `depth_decay` | Вероятностное затухание глубины при поиске. | 0.0–1.0 |
| `quorum` | Минимальный консенсус агентов перед фиксацией шага. | 0–1 |
| `temperature` | Стохастичность выбора операторов в DSL. | 0.0–1.0 |
| `eff_threshold` | Порог эффективности кандидата, прежде чем записывать в лог. | 0–1 |
| `max_complexity` | Ограничение на сложность формулы. | >0 |
| `seed` | Инициализация PRNG для воспроизводимости. | целое |

Любые изменения параметров документируйте в этом разделе и в
`runtime_and_operations.md`.

## Требования к нефункциональным характеристикам

- **Воспроизводимость** — идентичные входы и конфиги приводят к одинаковым
  журналам. Проверяется `kolibri_verify` и тестами `tests/test_reason_payload.py`.
- **Приватность по умолчанию** — навыки не получают данные без явной записи в
  политиках `PrivacyOperator`.
- **Офлайн-устойчивость** — runtime должен корректно выполнять сценарии без
  сети, откладывая синхронизацию IoT и KG.
- **Объяснимость** — каждый ответ сопровождается ReasoningLog и ссылками на
  источники из KG.

## Связанные документы

- [project_overview.md](project_overview.md) — продуктовое видение и сценарии.
- [module_reference.md](module_reference.md) — детализация модулей и API.
- [roadmap.md](roadmap.md) — план внедрения возможностей.

